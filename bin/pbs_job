#!/usr/bin/env ruby
require "rubygems"
require 'thor'
require 'date'

module PbsJob
  class New < Thor::Group
    include Thor::Actions

    argument :name, :desc => 'Name of the new job.'
    argument :email_address, :desc => 'Email to which to send PBS alerts.'

    class_option(
      :link_results,
      {
        :desc => 'Directory to which to redirect results',
        :default => nil,
        :aliases => 'r'
      }
    )
    class_option(
      :script,
      {
        :desc => 'Type of script to make the task script',
        :default => '<script type>',
        :aliases => 's'
      }
    )

    def self.source_root
      File.expand_path('../../', __FILE__)
    end

    def gen_root
      today = Date.today
      month = Date::MONTHNAMES[today.month].downcase

      @job_root = "#{name}.#{month}#{today.day}_#{today.year}"
      empty_directory @job_root
    end

    def qsub_script
      create_file_from_template 'job.qsub'
    end

    def pbs_script
      create_file_from_template 'job.pbs'
    end

    def task
      create_file_from_template 'task'
    end

    def results
      results_dir = "#{@job_root}/results"
      if options[:link_results]
        create_link(results_dir, options[:link_results])
      else
        empty_directory results_dir
      end
    end

    def streams
      empty_directory "#{@job_root}/streams"
    end

    private

    def create_file_from_template(file_name)
      template(
        "templates/#{file_name}.tt",
        "#{@job_root}/#{file_name}"
      )
    end
  end

  class PbsJob < Thor
    map 'n' => :new

    register(
      New,
      'new',
      'new NAME EMAIL_ADDRESS [OPTIONS]',
      "Creates a new PBS job with the name NAME and arranges for PBS alerts to be sent to EMAIL_ADDRESS, customized by OPTIONS"
    )
    tasks["new"].options = New.class_options
  end
end

PbsJob::PbsJob.start(ARGV)