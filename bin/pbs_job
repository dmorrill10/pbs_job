#!/usr/bin/env ruby
require "rubygems"
require 'thor'
require 'date'

module PbsJob
  class Generate < Thor::Group
    include Thor::Actions

    argument :name, :type => :string, :desc => 'Name of the new job.'
    argument :email_address, :type => :string, :desc => 'Email to which to send PBS alerts.'

    def self.source_root
      File.expand_path('../../', __FILE__)
    end

    def gen_root
      today = Date.today
      month = Date::MONTHNAMES[today.month].downcase

      @job_root = "#{name}.#{month}#{today.day}_#{today.year}"
      empty_directory @job_root
    end

    def qsub_script
      create_file_from_template 'job.qsub'
    end

    def pbs_script
      create_file_from_template 'job.pbs'
    end

    def task
      create_file_from_template 'task'
    end

    def results
      empty_directory "#{@job_root}/results"
    end

    def streams
      empty_directory "#{@job_root}/streams"
    end

    private

    def create_file_from_template(file_name)
      template(
        "templates/#{file_name}.tt",
        "#{@job_root}/#{file_name}"
      )
    end
  end

  class PbsJob < Thor
    map 'g' => :generate

    register(
      Generate,
      'generate',
      'generate NAME EMAIL_ADDRESS',
      "Generates a new PBS job with the name NAME and arranges for PBS alerts to be sent to EMAIL_ADDRESS"
    )
  end
end

PbsJob::PbsJob.start(ARGV)